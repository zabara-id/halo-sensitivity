# Halo Sensitivity

Исследовательский инструментарий для анализа устойчивости и чувствительности гало-орбит в системе Земля–Луна. Репозиторий объединяет дифференциально-алгебраические расчёты (на базе `daceypy`), статистические эксперименты и визуализацию результатов для задач в рамках ограниченной круговой задачи трёх тел (CR3BP).

> **TL;DR (English)**: Numerical and differential-algebra tools for studying Earth–Moon halo orbits, including Monte-Carlo sensitivity studies, polynomial state transition maps, and Jupyter notebooks powered by the `uv` Python workflow.

## Основные возможности
- Дифференциально-алгебраические интеграторы (`utils/libration_sense.py`) для CR3BP с поддержкой построения полиномиальных отображений состояния.
- Массовые испытания устойчивости (`appr_order_check.py`) с многопроцессорным прогоном и сохранением результатов в CSV.
- Постобработка и сравнение порядков аппроксимации (`appr_order_analyze.py`) с логарифмическими графиками ошибок.
- Подготовленные наборы коэффициентов и вспомогательные визуализации (`utils/graphL1.py`, `utils/graphL2.py`, `utils/visuals.py`).
- Научные Jupyter-ноутбуки с промежуточными расчётами и проверками теории.

## Структура проекта
| Путь | Назначение |
| --- | --- |
| `appr_order_check.py` | Монте-Карло сравнение полиномиальной аппроксимации и точной интеграции для точек гало-орбиты. |
| `appr_order_analyze.py` | Построение сводных графиков ошибок по порядкам аппроксимации. |
| `utils/libration_sense.py` | Библиотека для CR3BP: интеграторы RK78, преобразования единиц, генераторы орбит и функций чувствительности. |
| `utils/monodromy_matrix.py` | Вычисление монодромии и вспомогательных производных для анализа устойчивости. |
| `utils/graphL1.py`, `utils/graphL2.py`, `utils/visuals.py` | Сценарии визуализации коэффициентов, отклонений и облаков точек. |
| `data/` | Входные каталоги с фазовыми векторами и каталоги с сохранёнными результатами/коэффициентами. |
| `pyproject.toml`, `uv.lock` | Описание зависимостей и «замороженное» решение пакетов для `uv`. |

## Данные
- `data/input/HOPhaseVectorsEarthMoonL1.csv` и `HOPhaseVectorsEarthMoonL2.csv` — каталоги фазовых векторов гало-орбит.
- `data/output/L1-192-results/` — пример результирующих CSV по порядкам аппроксимации (1–7).
- `data/output/coefficients/` — табличные коэффициенты и статистики для визуализации.

При необходимости направлять новые результаты в отдельную папку: скорректируйте путь `filepath` в `appr_order_check.py` (по умолчанию `data/input/...`).

## Установка и настройка (uv)
### Предварительные требования
- [uv](https://docs.astral.sh/uv/) ≥ 0.5 — быстрый менеджер Python-зависимостей.
- Python 3.13 (uv установит и зафиксирует точную версию из `uv.lock`).
- Git LFS **не требуется**: все крупные CSV находятся в репозитории локально.

### Быстрый старт
1. **Установите uv**
   ```bash
   curl -LsSf https://astral.sh/uv/install.sh | sh
   ```
   На Windows (PowerShell):
   ```powershell
   irm https://astral.sh/uv/install.ps1 | iex
   ```
2. **Подготовьте интерпретатор и виртуальную среду**
   ```bash
   cd halo-sensitivity
   uv python install 3.13
   uv venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```
3. **Синхронизируйте зависимости**
   ```bash
   uv sync
   ```
   Команда создаст среду, строго соответствующую `uv.lock` и `pyproject.toml`.

После активации среды используйте `uv run <команда>` для гарантированного запуска с правильными зависимостями (переменные окружения и путь интерпретатора выставляются автоматически).

## Основные сценарии
### 1. Генерация сравнений аппроксимации (`appr_order_check.py`)
```bash
uv run python appr_order_check.py
```
Скрипт читает параметры гало-орбиты из CSV, генерирует случайные отклонения и сравнивает результат полиномиальной аппроксимации с точной интеграцией. Параметры в начале файла:
- `ord` — порядок DA-аппроксимации (по умолчанию 7).
- `haloorbit_type`, `haloorbit_num` — код каталога и номер орбиты (например, L1/192).
- `haloorbit_dots_num`, `dots_around_num` — количество точек аппроксимации и размера облака Монте-Карло.
- `filepath` — целевой CSV; убедитесь, что папка существует.

### 2. Постобработка результатов (`appr_order_analyze.py`)
```bash
uv run python appr_order_analyze.py
```
Сценарий агрегирует CSV из каталога (по умолчанию `data/output/L1-192-results/`), строит график максимальной ошибки положения и выводит значения в консоль. Измените `dir_path` для работы с собственными наборами данных.

### 3. Визуализация и лабораторные исследования
- `uv run python utils/graphL1.py` / `graphL2.py` — отображение коэффициентов и отклонений.
- `uv run python utils/visuals.py` — построение 3D-облаков или карт отклонений (см. функции `dots_graph` и `deviation_graph`).
- Ноутбуки (`*.ipynb`) запускаются через `Jupyter`:
  ```bash
  uv run jupyter lab
  ```
  или
  ```bash
  uv run jupyter notebook
  ```

## Работа с uv во время разработки
- Добавление зависимости: `uv add <имя-пакета>` (обновит `pyproject.toml` и `uv.lock`).
- Удаление: `uv remove <имя-пакета>`.
- Обновление существующих пакетов: `uv lock --upgrade` (можно уточнять имена через `uv lock --upgrade numpy scipy`).
- Повторное восстановление окружения с точностью до байта: `uv sync --frozen` (подходит для CI).
- Проверка непротиворечивости пакетов: `uv pip check`.

### Совместимость с «pip»
Файл `requirements.txt` сохранён для справки, однако основной источник истины — `pyproject.toml` + `uv.lock`. Для ручной установки без uv можно выполнить `pip install -r requirements.txt`, но такая установка не гарантирует идентичность версий.

## Рекомендации по вычислительным экспериментам
- Расчёты Monte-Carlo в `appr_order_check.py` масштабируются по CPU. При первом запуске можно снизить `dots_around_num` (например, до `1_000`) чтобы проверить конвейер.
- Функции из `utils/libration_sense.py` предполагают работу в безразмерных единицах CR3BP; используйте вспомогательные преобразования (`du2km`, `km2du`, `vu2kms`, `kmS2vu`) для интерпретации результатов.
- При изменении исходных данных убедитесь, что CSV имеют ту же структуру (шесть компонент фазового вектора на строку).

## Диагностика и отладка
- Если `daceypy` не может загрузить бинарные расширения, убедитесь, что среда соответствует Python ≥ 3.13 и у вас установлены инструменты сборки (на macOS — `xcode-select --install`).
- При проблемах с отображением графиков в headless-средах установите бэкенд: `MPLBACKEND=Agg uv run python appr_order_analyze.py`.
- Для воспроизводимости фиксируйте генератор случайных чисел (см. параметр `seed` в `appr_order_check.py`).

## Лицензия и вклад
Лицензия не указана. Перед публикацией результатов уточните условия распространения данных. Вопросы и улучшения можно вносить через Issues или Pull Requests.

