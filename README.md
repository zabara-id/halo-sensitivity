# Halo Sensitivity

Исследовательский инструментарий для анализа устойчивости и чувствительности гало-орбит в системе Земля–Луна. Репозиторий объединяет дифференциально-алгебраические расчёты (на базе `daceypy`), статистические эксперименты и визуализацию результатов для задач в рамках ограниченной круговой задачи трёх тел (CR3BP).

> **TL;DR (English)**: Numerical and differential-algebra tools for studying Earth–Moon halo orbits, including Monte-Carlo sensitivity studies, polynomial state transition maps, and Jupyter notebooks powered by the `uv` Python workflow.

## Основные возможности
- Библиотека `utils/libration_sense.py` с DA-интеграторами, преобразованиями единиц и генерацией орбит CR3BP.
- Скрипты `appr_order_check.py` и `appr_order_analyze.py` для массовых расчётов и оценки точности полиномиальных аппроксимаций.
- Вспомогательные визуализации (`utils/graphL1.py`, `graphL2.py`, `visuals.py`) и исследовательские Jupyter-ноутбуки.

## Структура проекта
| Путь | Назначение |
| --- | --- |
| `appr_order_check.py` | Монте-Карло сравнение DA и точной интеграции для точек гало-орбиты. |
| `appr_order_analyze.py` | Сводные графики ошибок по порядкам аппроксимации. |
| `utils/libration_sense.py` | Интеграторы RK78, преобразования единиц и генераторы орбит. |
| `utils/monodromy_matrix.py` | Расчёт монодромии и вспомогательных производных. |
| `utils/graphL1.py`, `graphL2.py`, `visuals.py` | Графики коэффициентов, облака точек и карты отклонений. |
| `data/` | Входные фазовые векторы и сохранённые результаты/коэффициенты. |
| `pyproject.toml`, `uv.lock` | Зависимости проекта и решение пакетов для `uv`. |

## Данные
- `data/input/HOPhaseVectorsEarthMoonL1.csv` и `HOPhaseVectorsEarthMoonL2.csv` — фазовые векторы каталога гало-орбит.
- `data/output/L1-192-results/` — эталонные CSV с результатами для порядков 1–7.
- `data/output/coefficients/` — коэффициенты и статистики для визуализаций.

Новые результаты сохраняйте в собственный каталог, скорректировав `filepath` в `appr_order_check.py` (по умолчанию путь ведёт в `data/input/...`).

## Установка и настройка (uv)
### Предварительные требования
- [uv](https://docs.astral.sh/uv/) ≥ 0.5 — быстрый менеджер Python-зависимостей.
- Python 3.13 (uv установит и зафиксирует точную версию из `uv.lock`).
- Git LFS **не требуется**: все крупные CSV находятся в репозитории локально.

### Быстрый старт
1. **Установите uv**
   ```bash
   curl -LsSf https://astral.sh/uv/install.sh | sh
   ```
   На Windows (PowerShell):
   ```powershell
   irm https://astral.sh/uv/install.ps1 | iex
   ```
2. **Подготовьте интерпретатор и виртуальную среду**
   ```bash
   cd halo-sensitivity
   uv python install 3.13
   uv venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```
3. **Синхронизируйте зависимости**
   ```bash
   uv sync
   ```
   Команда создаст среду, строго соответствующую `uv.lock` и `pyproject.toml`.

4. **Установите сам проект в режиме разработки**
   ```bash
   uv pip install -e .
   ```
   Это добавляет пакет `halo-sensitivity` в `site-packages`, поэтому скрипты и ноутбуки из любых подкаталогов могут импортировать `utils` и другие модули без правок `sys.path`. Используйте именно `uv pip install -e .`; команда `uv add .` запрещена, потому что добавление собственного проекта в зависимости не поддерживается.

После активации среды используйте `uv run <команда>` для гарантированного запуска с правильными зависимостями (переменные окружения и путь интерпретатора выставляются автоматически).

## Основные сценарии
- `uv run python appr_order_check.py` — сравнение полиномиальной аппроксимации с точной интеграцией (настройки задаются в начале файла).
- `uv run python appr_order_analyze.py` — агрегация итоговых CSV и построение графиков ошибок.
- `uv run python utils/graphL1.py` / `graphL2.py` / `visuals.py` — визуализации коэффициентов, облаков точек и карт отклонений.
- `uv run jupyter lab` (или `uv run jupyter notebook`) — запуск исследовательских ноутбуков с теми же зависимостями.

## Работа с uv во время разработки
- `uv add <имя>` / `uv remove <имя>` — актуализировать зависимости.
- `uv lock --upgrade` — обновить версии (можно указать конкретные пакеты).
- `uv sync --frozen` — пересобрать окружение один в один (например, на CI).
- `uv pip check` — убедиться в целостности зависимостей.

Файл `requirements.txt` оставлен для совместимости, но эталонные версии задаёт пара `pyproject.toml` + `uv.lock`.

## Полезно знать
- Monte-Carlo в `appr_order_check.py` масштабируется по CPU; для теста можно временно снизить `dots_around_num`.
- Все функции `utils/libration_sense.py` работают в безразмерных единицах CR3BP — используйте `du2km`, `km2du`, `vu2kms`, `kmS2vu` для перевода результатов.
- CSV должны сохранять структуру «шесть компонент на строку».
- Если `daceypy` жалуется на сборку, проверьте наличие инструментов компиляции и что запущен Python ≥ 3.13.
- В headless-режимах для построения графиков можно установить `MPLBACKEND=Agg`.

## Лицензия и вклад
Лицензия не указана. Перед публикацией результатов уточните условия распространения данных. Вопросы и улучшения можно вносить через Issues или Pull Requests.
